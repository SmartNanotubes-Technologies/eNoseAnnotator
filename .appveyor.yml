skip_non_tags: true

image: Visual Studio 2019
install:
  - set QTDIR=C:\Qt\5.13.2\msvc2017_64
  - set PATH=%QTDIR%\bin;\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build;%PATH%;
build_script:
  # info
  - echo "%APPVEYOR_REPO_TAG_NAME%"
  # get libtorch
  - curl https://download.pytorch.org/libtorch/cpu/libtorch-win-shared-with-deps-1.4.0.zip -o libtorch-win-shared-with-deps-1.4.0.zip
  - ps: Expand-Archive -Force libtorch-win-shared-with-deps-1.4.0.zip app/lib/
  # setup build env
  - vcvars64.bat
  #- set QMAKESPEC=win32-msvc
  # build app
  - qmake -config release -r eNoseAnnotator.pro
  - nmake
  - cd "app/release/"
  - ren app.exe eNoseAnnotator.exe
  - cd ../..
after_build:
  # create executable
  - cd app
  - windeployqt --compiler-runtime release/eNoseAnnotator.exe
  # remove unneeded files
  - rm release/*.obj
  - rm release/*.cpp
  - rm release/*.h
  # create directories to be deployed
  - cd ..
  - mkdir "eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/data/" "eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/export/" "eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/presets/" "eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/classifiers/"
  - cp app/lib/libtorch/lib/*.dll "eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/"
  - cp -r app/release/* "eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/"
  - cp -r misc/presets "eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/eNoseAnnotator-%APPVEYOR_REPO_TAG_NAME%-Windows/"
  - dir

artifacts:
  - path: "eNoseAnnotator-${APPVEYOR_REPO_TAG_NAME}-Windows"
    type: zip

# scripts to run before deployment
before_deploy:
   - if "%APPVEYOR_REPO_TAG_NAME%" == "continuous" setx ENOSE_RELEASE=true else setx ENOSE_RELEASE=false

deploy:
  - provider: GitHub
    name: prerelease
    on:
       APPVEYOR_REPO_TAG: true
       ENOSE_RELEASE: false
    artifact: "eNoseAnnotator-${APPVEYOR_REPO_TAG_NAME}-Windows.zip"
    draft: false
    prerelease: true
    force_update: true
    auth_token:
      secure: vgEATF2g25z4SRuiZeER1PiOcABqDjPdOilt5Yb0irKOVbhT14kQcPVNQ5UEbQ75	
  
  - provider: GitHub
    name: release
    on:
       APPVEYOR_REPO_TAG: true
       ENOSE_RELEASE: true
    artifact: "eNoseAnnotator-${APPVEYOR_REPO_TAG_NAME}-Windows.zip"
    draft: false
    prerelease: false
    force_update: true
    auth_token:
      secure: vgEATF2g25z4SRuiZeER1PiOcABqDjPdOilt5Yb0irKOVbhT14kQcPVNQ5UEbQ75	
